version: v1.0
name: GitLint

agent:
  machine:
    type: e1-standard-2
  containers:
    - name: main
      image: "rust:1.53.0"

global_job_config:
  prologue:
    commands:
      # - install-package lftp
      - checkout --use-cache
      # - cache restore v1-rustup-$(checksum Cargo.lock)

blocks:
  - name: Build
    task:
      jobs:
      - name: Rust Lint
        commands:
          - rustup component add rustfmt
          - cargo fmt --all -- --check
      - name: Build & Test
        env_vars:
          - name: RUST_BACKTRACE
            value: "1"
        commands:
          - git config --global user.email "test@test.com"
          - git config --global user.name "My Test user"
          - cargo test
          # - cache store v1-rustup-$(checksum Cargo.lock) $RUSTUP_HOME
      - name: Lint Lint
        commands:
          - cargo run -- $SEMAPHORE_GIT_COMMIT_RANGE
