version: v1.0
name: GitLint

agent:
  machine:
    type: e1-standard-2
  containers:
    - name: main
      image: 'registry.semaphoreci.com/rust:1.53'

global_job_config:
  env_vars:
    - name: CARGO_HOME
      value: "/root/.cargo"
  prologue:
    commands:
      - checkout --use-cache
      - cache restore v1-cargo-$(checksum Cargo.lock)

blocks:
  - name: Build
    dependencies: []
    task:
      jobs:
      - name: Rust Lint
        commands:
          - cargo fmt --all -- --check
      - name: Build & Test
        env_vars:
          - name: RUST_BACKTRACE
            value: "1"
        commands:
          - git config --global user.email "test@test.com"
          - git config --global user.name "My Test user"
          - cargo test
          - cache store v1-cargo-$(checksum Cargo.lock) $CARGO_HOME
  - name: Test run the project
    dependencies: ["Build"]
    task:
      jobs:
      - name: Run project to lint
        commands:
          - cargo run -- $SEMAPHORE_GIT_COMMIT_RANGE
